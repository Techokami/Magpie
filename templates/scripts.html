<script src="static/lib/jquery/jquery-3.6.0.min.js"></script>
<script src="static/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="static/lib/light-switch-bootstrap-0.1.3/switch.js"></script>

<!-- Activate the bootstrap tooltips -->
<script type="application/javascript">
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
</script>

<!-- Main scripts -->
<script type="application/javascript">
    function refreshItems() {
        $.ajax({
            type: "POST",
            url: "/items",
            data: {
                args: JSON.stringify(args),
            },
            success: function(response) {
                $('#itemContainer').html(response);
                initKnownItems();
                refreshMap();
             }
        });
    }

    function refreshMap() {
        $.ajax({
            type: "POST",
            url: "/map",
            data: {
                args: JSON.stringify(args),
                inventory: JSON.stringify(inventory),
            },
            success: function(response) {
                $('#mapContainer').html(response);
                refreshChecked();
             }
        });
    }

    function preventDoubleClick(event) {
        if (event.detail > 1) {
            event.preventDefault();
        }
    }

    {% if local %}
    async function getRequest(url='') {
        const response = await fetch(url, {
          method: 'GET', 
          cache: 'no-cache'
        })
        return response.json()
    }

    document.addEventListener('DOMContentLoaded', function() {
    
    let url = document.location
    let route = "/flaskwebgui-keep-server-alive"
    let interval_request = 3 * 1000 //sec
    
    function keep_alive_server(){
        getRequest(url + route)
        .then(data => console.log(data))
    }
    
    setInterval(keep_alive_server, interval_request)()
    
    })
    {% endif %}
</script>

<!-- Item panel scripts -->
<script src="{{ url_for('static', filename='js/items.js') }}"></script>
<script type="application/javascript">
    function tunicSrc()
    {
        blue = inventory['BLUE_TUNIC'] > 0;
        red = inventory['RED_TUNIC'] > 0;

        if (!blue && !red)
        {
            return 'static/images/GREEN_TUNIC.png';
        }
        if (blue && !red)
        {
            return 'static/images/BLUE_TUNIC.png';
        }
        if (!blue && red)
        {
            return 'static/images/RED_TUNIC.png';
        }
        
        return 'static/images/BLUERED_TUNIC.png';
    }

    initKnownItems();
</script>

<!-- Flag panel scripts -->
<script type="application/javascript">
    const defaultArgs = JSON.parse('{{jsonArgs|safe}}');

    function saveArgs() {
        var flags = document.querySelectorAll('[data-flag]');

        for (const flag of flags) {
            name = flag.dataset.flag;
            if (flag.type == 'checkbox') {
                value = flag.checked;
            }
            else {
                value = flag.value;
            }

            args[name] = value;
        }

        localStorage.setItem('args', JSON.stringify(args));
        refreshItems();
    }

    function loadArgs() {
        try {
            args = JSON.parse(localStorage.getItem('args'));
        }
        catch (err) {
        }

        try {
            if (!('logic' in args)) {
                args = defaultArgs;
            }
        }
        catch (err) {
            args = defaultArgs;
        }

        var flags = document.querySelectorAll('[data-flag]');
        for (const flag of flags) {
            name = flag.dataset.flag;

            if (name in args) {
                if (flag.type == 'checkbox') {
                    flag.checked = args[name];
                }
                else {
                    flag.value = args[name];
                }
            }
        }

        refreshItems();
    }

    loadArgs();
</script>

<!-- Map scripts -->
<script type="application/javascript">
    var checkedChecks = null;

    function saveChecked() {
        localStorage.setItem('checkedChecks', JSON.stringify(checkedChecks));
    }

    function loadChecked() {
        try {
            checkedChecks = JSON.parse(localStorage.getItem('checkedChecks'));
        }
        catch (err) {
            checkedChecks = {};
        }

        if (checkedChecks == null) {
            checkedChecks = {};
        }

        refreshChecked();
    }

    function getCheckedKey(area, name) {
        return `${area}-${name}`;
    }

    function toggleCheck(event, element) {
        var area = element.dataset.checkarea;
        var name = element.dataset.checkname;
        var logic = $(element).closest(".row[data-logic]").attr('data-logic');
        var key = getCheckedKey(area, name);

        if (logic != 'Checked') {
            check = new Object();
            check.name = name;
            check.area = area;

            checkedChecks[key] = check;
            moveCheckToChecked(element);
        }
        else {
            delete checkedChecks[key];
            moveCheckFromChecked(element);
        }

        saveChecked();

        if (event.detail > 1) {
            event.preventDefault();
        }
    }

    function moveCheckToChecked(element) {
        var logic = element.dataset.logic;
        var area = element.dataset.checkarea;
        var destArea = $(`[data-logic="Checked"] [data-area="${area}"]`)
        var sourceArea = $(`[data-logic="${logic}"] [data-area="${area}"]`);

        if (destArea.length == 0) {
            var destLogic = $('.row[data-logic=Checked]');
            var accordionItem = $(destLogic).closest('.accordion-item');
            var newCard = $(sourceArea).clone();

            ul = newCard.find('ul');
            $(ul).html('');

            accordionItem.removeClass('hidden');
            $(destLogic).append(newCard);

            destArea = $(`[data-logic="Checked"] [data-area="${area}"]`)
        }

        ul = destArea.find('ul');
        $(ul).append(element);

        if ($(sourceArea).find('ul').children().length == 0) {
            $(sourceArea).remove();
        }

        if (logic != 'In logic') {
            var sourceLogic = $(`.row[data-logic="${logic}"]`).closest('.accordion-item');
            if ($(sourceLogic).find('[data-area]').length == 0) {
                $(sourceLogic).addClass('hidden');
            }
        }
    }

    function moveCheckFromChecked(element) {
        var logic = element.dataset.logic;
        var area = element.dataset.checkarea;
        var destArea = $(`[data-logic="${logic}"] [data-area="${area}"]`);
        var sourceArea = $(`[data-logic="Checked"] [data-area="${area}"]`)

        if (destArea.length == 0) {
            var destLogic = $(`.row[data-logic="${logic}"]`);
            var accordionItem = $(destLogic).closest('.accordion-item');
            var newCard = $(sourceArea).clone();

            ul = newCard.find('ul');
            $(ul).html('');

            accordionItem.removeClass('hidden');
            $(destLogic).append(newCard);

            destArea = $(`[data-logic="${logic}"] [data-area="${area}"]`);
        }

        ul = destArea.find('ul');
        $(ul).append(element);

        if ($(sourceArea).find('ul').children().length == 0) {
            $(sourceArea).remove();
        }

        var sourceLogic = $(`.row[data-logic="Checked"]`).closest('.accordion-item');
        if ($(sourceLogic).find('[data-area]').length == 0) {
            $(sourceLogic).addClass('hidden');
        }
    }

    function refreshChecked() {
        for (var key in checkedChecks) {
            var check = checkedChecks[key];
            element = $(`li[data-checkarea="${check.area}"][data-checkname="${check.name}"]`);
            if (element.length > 0) {
                moveCheckToChecked(element[0]);
            }
        }
    }

    function resetChecks() {
        checkedChecks = {};
        saveChecked();
    }

    loadChecked();
</script>