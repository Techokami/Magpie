<script src="static/lib/jquery/jquery-3.6.0.min.js"></script>
<script src="static/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="static/lib/light-switch-bootstrap-0.1.3/switch.js"></script>
<script src="static/lib/jquery.connections/jquery.connections.js"></script>
<script src="static/lib/summernote/summernote-lite.js"></script>
<script src="static/js/util.js"></script>
<script src="static/js/model/mapNode.js"></script>
<script src="static/js/model/nodeTooltip.js"></script>
<script src="static/js/model/check.js"></script>
<script src="static/js/model/entrance.js"></script>
<script src="static/js/model/connection.js"></script>
<script src="static/js/model/boss.js"></script>
<script src="static/js/map/connectorDialog.js"></script>
<script src="static/js/map/graphics.js"></script>
<script src="static/js/map/input.js"></script>
<script src="static/js/map/nodes.js"></script>
<script src="static/js/map/tooltips.js"></script>
<script src="static/js/metadata/checkMetadata.js"></script>
<script src="static/js/metadata/entranceMetadata.js"></script>
<script src="static/js/metadata/connectorMetadata.js"></script>
<script src="static/js/metadata/bossMetadata.js"></script>
<script src="static/js/metadata/mapMetadata.js"></script>
<script src="static/js/state/settings.js"></script>
<script src="static/js/state/items.js"></script>
<script src="static/js/state/locations.js"></script>
<script src="static/js/state/undo.js"></script>
<script src="static/js/state/checkContents.js"></script>
<script src="static/js/state/bosses.js"></script>
<script src="static/js/checkList.js"></script>
<script src="static/js/items.js"></script>
<script src="static/js/messaging.js"></script>
<script src="static/js/spoilerLog.js"></script>
<script src="static/js/plando.js"></script>
<script src="static/js/ndi.js"></script>
<script src="static/lib/masonry/masonry.pkgd.min.js"></script>
<script src="static/lib/html-to-image/html-to-image.js"></script>

<script type="application/javascript">
    "use strict"

    const protocolVersion = '1.1';
    const defaultArgs = JSON.parse('{{jsonArgs|safe}}');
    const defaultSettings = JSON.parse('{{jsonSettings|safe}}')
    var settingsOverrides = JSON.parse('{{jsonSettingsOverrides|safe}}')
    var argsOverrides = JSON.parse('{{jsonArgsOverrides|safe}}')
    var diskSettings = JSON.parse('{{diskSettings|safe}}')
    var startLocations = [];
    var randomizedEntrances = null;
    var localSettings = null;
    var entranceMap = {};
    var reverseEntranceMap = {};
    var connections = [];
    var bossMap = {};
    var checkedChecks = new Set();
    var checkContents = {};
    var itemLocations = {};
    var hoveredItems = [];
    var inventory = {};
    var mapNodes = null;
    var args = null;
    var skipNextAnimation = true;
    var undoStack = [];
    var redoStack = [];
    var graphicalMapSource = null;
    var graphicalMapChoices = null;
    var graphicalMapType = null;
    var autotrackerSocket = null;
    var romRequested = false;
    var autotrackerFeatures = [];
    var currentRoom = null;
    var currentX = null;
    var currentY = null;
    var overworldRoom = null;
    var iconStyles = $('link[href="/static/css/icons.css"]')[0].sheet;
    var themeStyles = $('link[href="/static/css/theme.css"]')[0].sheet;
    var local = '{{local}}' == 'True'
    var remoteProtocolVersion = null;
    var checkSize = 16;
    var skipSettingsSave = false;
    var maxInventory = {};
    var errorLog = [];
    var messageQueue = [];
    var settingsPending = false;

    const startHouse = 'start_house';

    function refreshItems() {
        $.ajax({
            type: "POST",
            url: "/items",
            data: {
                args: JSON.stringify(args),
                localSettings: JSON.stringify(localSettings),
            },
            success: function(response) {
                if (localSettings.showItemsOnly) {
                    $('#checkList').hide();
                    $('#mapContainer').hide();
                }
                else {
                    $('#checkList').show();
                    $('#mapContainer').show();
                }

                $('#itemContainer').html(response);

                if (localSettings.highlightItemsOnHover) {
                    $('.itemImage').addClass('glow');
                }
                else {
                    $('.itemImage').removeClass('glow');
                }


                refreshItemNdi();
                initKnownItems();
                refreshCheckList();
             }
        });
    }

    function refreshCheckList() {
        let tempInventory = structuredClone(inventory);

        // Kiki is logically important since they open the bridge
        if (Check.isChecked('Ukuku Prairie-Kiki')) {
            tempInventory['TRADING_ITEM_BANANAS'] = 1;
        }

        let bossList = getBossList();
        let minibossMap = getMinibossMap();

        $.ajax({
            type: "POST",
            url: "/checkList",
            data: {
                args: JSON.stringify(args),
                inventory: JSON.stringify(tempInventory),
                entranceMap: JSON.stringify(entranceMap),
                bossList: JSON.stringify(bossList),
                minibossMap: JSON.stringify(minibossMap),
            },
            success: function(response) {
                pruneEntranceMap();

                $('#checkList').html(response);

                pruneEntranceMap();
                fillVanillaLogEntrances();
                updateEntrances();

                drawActiveTab();
                refreshTextChecks();
            }
        });
    }

    function loadShortString(saveOnLoad=false) {
        let shortString = $("#shortString")[0].value;

        $.ajax({
            type: "POST",
            url: "/shortString",
            data: {
                shortString: shortString,
            },
            success: function(response) {
                let newArgs = JSON.parse(response);
                fixArgs(newArgs);
                setInputValues('flag', newArgs);

                if (saveOnLoad) {
                    saveSettings();
                }

                settingsPending = false;

                for (const message of messageQueue) {
                    processMessage(message);
                }

                messageQueue = [];
            }
        });
    }

    function loadSpoilerLog(romData) {
        $.ajax({
            type: "POST",
            url: "/spoilerLog",
            data: {
                romData: btoa(romData),
            },
            success: function(response) {
                loadLogContents(response);
            }
        });
    }

    function errorHandler(e) {
        errorLog.push({
            col: e.colno,
            line: e.lineno,
            message: e.error.message,
            stack: e.error.stack,
            filename: e.filename,
            time: e.timeStamp,
        });
    }

    function init() {
        window.addEventListener('error', errorHandler);

        modifyTooltipAllowList();
        initKnownItems();

        if ('args' in diskSettings) {
            localStorage.setItem('args', diskSettings['args'])
        }

        if ('localSettings' in diskSettings) {
            localStorage.setItem('settings', diskSettings['localSettings'])
        }

        let storage = { ...localStorage };
        let settingsErrors = loadSettings();
        let locationErrors = loadLocations();
        let checkErrors = loadCheckContents();

        loadBosses();

        $(document).keydown(keyDown);

        document.addEventListener('DOMContentLoaded', function() {
            connectToAutotracker();

            setInterval(connectToAutotracker, 3 * 1000);
        });

        $('#connectorModal').on('hide.bs.modal', () => { endGraphicalConnection(); });

        $(document).ready(function() {
            $('#bodyTextArea').summernote({
                height: 320,
            });
            $('#errorTextArea').summernote({
                height: 200,
            });
        });

        if (settingsErrors.length || locationErrors.length || checkErrors.length) {
            let payload = {
                'settingsErrors': settingsErrors.map(x => x.toString()),
                'locationErrors': locationErrors.map(x => x.toString()),
                'checkErrors': checkErrors.map(x => x.toString()),
                'storage': storage,
            };

            showErrorDialog("An error occurred while loading one or more types of data. Defaults will be loaded.", JSON.stringify(payload, null, 3));
        }

        $("#argsOffcanvas").on("hide.bs.offcanvas", function() {
            /*if(skipSettingsSave) {
                skipSettingsSave = false;
                console.log("skipping");
                return;
            }

            console.log("saving");*/
            saveSettings();
        });

        applySettings();
    }

    init();

</script>